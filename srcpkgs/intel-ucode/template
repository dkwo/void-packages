# Template file for 'intel-ucode'
pkgname=intel-ucode
version=20231114
revision=2
archs="i686* x86_64*"
hostmakedepends="iucode-tool"
short_desc="Microcode update files for Intel CPUs"
maintainer="Orphaned <orphan@voidlinux.org>"
license="custom: Proprietary"
homepage="https://github.com/intel/Intel-Linux-Processor-Microcode-Data-Files"
changelog="https://raw.githubusercontent.com/intel/Intel-Linux-Processor-Microcode-Data-Files/main/releasenote.md"
distfiles="https://github.com/intel/Intel-Linux-Processor-Microcode-Data-Files/archive/refs/tags/microcode-${version}.tar.gz"
checksum=cee26f311f7e2c039dd48cd30f995183bde9b98fb4c3039800e2ddaf5c090e55
repository=nonfree

do_build() {
	rm -f intel-ucode{,-with-caveats}/list
	iucode_tool -v --write-earlyfw=intel-ucode.img intel-ucode{,-with-caveats}/
}

do_install() {
	vinstall intel-ucode.img 0644 usr/lib/firmware/intel-ucode
	vlicense license

	vmkdir usr/lib/dracut/dracut.conf.d
	echo "early_microcode=yes" >> ${DESTDIR}/usr/lib/dracut/dracut.conf.d/intel_ucode.conf
}
